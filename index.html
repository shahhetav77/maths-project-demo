<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Matrix Transformation Simulator (Beige)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        /* --- MODIFIED: Added CSS Variables for Theming --- */
        :root {
            --bg-page: #f0f2f5;
            --bg-panel: #fff;
            --text-primary: #333;
            --text-secondary: #34495e;
            --text-header: #2c3e50;
            --border-color: #eee;
            --accent-color: #e74c3c;
            --accent-color-hover: #c0392b;
            --button-secondary-bg: #7f8c8d;
            --button-secondary-hover: #95a5a6;
            --button-primary-bg: #3498db;
            --button-primary-hover: #2980b9;
            --modal-bg: #fefefe;
            --modal-calc-bg: #ecf0f1;
            --modal-calc-border: #bdc3c7;
            --modal-calc-span-bg: #fff;
            --modal-close: #aaa;
            --modal-close-hover: #000;
        }

        body[data-theme="dark"] {
            --bg-page: #2c3e50;
            --bg-panel: #34495e;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-header: #fff;
            --border-color: #4a637b;
            --accent-color: #e74c3c;
            --accent-color-hover: #c0392b;
            --button-secondary-bg: #95a5a6;
            --button-secondary-hover: #7f8c8d;
            --button-primary-bg: #3498db;
            --button-primary-hover: #2980b9;
            --modal-bg: #34495e;
            --modal-calc-bg: #2c3e50;
            --modal-calc-border: #567;
            --modal-calc-span-bg: #4a637b;
            --modal-close: #bdc3c7;
            --modal-close-hover: #fff;
        }
        /* --- End of Theming Variables --- */

        /* --- Page Layout --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
            background-color: var(--bg-page); /* MODIFIED */
            color: var(--text-primary); /* MODIFIED */
            margin: 0;
            transition: background-color 0.2s, color 0.2s; /* MODIFIED */
        }

        /* --- Controls Panel (Mobile First) --- */
        #controls {
            width: 100%;
            padding: 20px;
            background-color: var(--bg-panel); /* MODIFIED */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            box-sizing: border-box;
            max-height: 50vh;
            transition: background-color 0.2s; /* MODIFIED */
        }
        
        h1 { font-size: 1.5em; text-align: center; color: var(--text-header); border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; margin-top: 0; }
        h2 { font-size: 1.1em; color: var(--text-secondary); margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: flex; justify-content: space-between; font-size: 0.9em; font-weight: bold; }
        .control-group label span { font-weight: normal; color: var(--accent-color); font-family: 'Courier New', Courier, monospace; }
        input[type="range"] { width: 100%; }
        
        /* --- 3D Scene (Mobile First) --- */
        #scene-container {
            width: 100%;
            height: 50vh;
            background-color: #F5F5DC; /* This will be controlled by JS */
        }
        canvas { display: block; }
        
        /* --- Buttons --- */
        button {
            width: 100%; padding: 10px; border: none; border-radius: 5px;
            font-size: 1em; font-weight: bold; cursor: pointer; margin-top: 20px;
            transition: background-color 0.2s; /* MODIFIED */
        }
        button#view-logic-btn { background-color: var(--button-primary-bg); color: white; }
        button#view-logic-btn:hover { background-color: var(--button-primary-hover); }
        button#reset-btn { background-color: var(--accent-color); color: white; }
        button#reset-btn:hover { background-color: var(--accent-color-hover); }
        
        /* MODIFIED: Added new button style */
        button#toggle-theme-btn {
            background-color: var(--button-secondary-bg);
            color: white;
            margin-top: 10px; /* Less margin */
        }
        button#toggle-theme-btn:hover { background-color: var(--button-secondary-hover); }
        
        /* --- Modal Styles --- */
        #modal-overlay {
            display: none; position: fixed; z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
        }
        #modal-content {
            display: none; position: fixed; z-index: 101; top: 50%; left: 50%;
            transform: translate(-50%, -50%); 
            background-color: var(--modal-bg); /* MODIFIED */
            padding: 20px;
            border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 400px;
        }
        #modal-close {
            color: var(--modal-close); /* MODIFIED */
            float: right; font-size: 28px; font-weight: bold;
            line-height: 1; padding: 0 5px; cursor: pointer;
        }
        #modal-close:hover { color: var(--modal-close-hover); } /* MODIFIED */
        .matrix { font-family: 'Courier New', Courier, monospace; font-size: 1.1em; line-height: 1.4; text-align: right; }
        #calculation-display {
            display: flex; align-items: center; justify-content: space-around;
            background-color: var(--modal-calc-bg); /* MODIFIED */
            padding: 15px; border-radius: 5px; margin-top: 10px;
        }
        .matrix-4x1 { display: grid; grid-template-rows: repeat(4, 1fr); gap: 5px; }
        .matrix-4x4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 0 10px; }
        .matrix-4x1 span, .matrix-4x4 span {
            padding: 5px; 
            background: var(--modal-calc-span-bg); /* MODIFIED */
            border: 1px solid var(--modal-calc-border); /* MODIFIED */
            border-radius: 3px; min-width: 30px;
        }
        .math-symbol { font-size: 1.5em; font-weight: bold; color: var(--text-secondary); }
        
        /* --- Desktop Layout --- */
        @media (min-width: 769px) {
            body {
                display: flex; /* Side-by-side layout */
                height: 100vh;
            }
            #controls {
                width: 350px; /* Fixed width on desktop */
                height: 100vh;
                max-height: 100vh; /* Override mobile max-height */
            }
            #scene-container {
                flex-grow: 1; /* Take up remaining space */
                height: 100vh; /* Full height */
            }
        }
        
    </style>
</head>
<body>

    <div id="controls">
        <h1>3D Transformations</h1>
        <h2>1. Translation (Tx, Ty, Tz)</h2>
        <div class="control-group"><label for="tx">Translate X <span>0.0</span></label><input type="range" id="tx" min="-5" max="5" value="0" step="0.1"></div>
        <div class="control-group"><label for="ty">Translate Y <span>0.0</span></label><input type="range" id="ty" min="-5" max="5" value="0" step="0.1"></div>
        <div class="control-group"><label for="tz">Translate Z <span>0.0</span></label><input type="range" id="tz" min="-5" max="5" value="0" step="0.1"></div>
        <h2>2. Rotation (Rx, Ry, Rz)</h2>
        <div class="control-group"><label for="rx">Rotate X (Pitch) <span>0째</span></label><input type="range" id="rx" min="-180" max="180" value="0" step="1"></div>
        <div class="control-group"><label for="ry">Rotate Y (Yaw) <span>0째</span></label><input type="range" id="ry" min="-180" max="180" value="0" step="1"></div>
        <div class="control-group"><label for="rz">Rotate Z (Roll) <span>0째</span></label><input type="range" id="rz" min="-180" max="180" value="0" step="1"></div>
        <h2>3. Scaling (Sx, Sy, Sz)</h2>
        <div class="control-group"><label for="sx">Scale X <span>1.0</span></label><input type="range" id="sx" min="0.1" max="3" value="1" step="0.1"></div>
        <div class="control-group"><label for="sy">Scale Y <span>1.0</span></label><input type="range" id="sy" min="0.1" max="3" value="1" step="0.1"></div>
        <div class="control-group"><label for="sz">Scale Z <span>1.0</span></label><input type="range" id="sz" min="0.1" max="3" value="1" step="0.1"></div>
        
        <button id="view-logic-btn">View Matrix Logic</button>
        <button id="reset-btn">Reset All</button>
        <button id="toggle-theme-btn">Switch to Dark Mode</button>

    </div>

    <div id="scene-container"></div>
    
    <div id="modal-overlay"></div>
    <div id="modal-content">
        <span id="modal-close">&times;</span> 
        <h2>Example Calculation (New = Final * Original)</h2>
        <div id="calculation-display">
            <div id="result-vector" class="matrix matrix-4x1"></div>
            <span class="math-symbol">=</span>
            <div id="final-matrix" class="matrix matrix-4x4"></div>
            <span class="math-symbol">*</span>
            <div id="original-vector" class="matrix matrix-4x1"></div>
        </div>
    </div>


    <script>
        // --- 1. GLOBAL VARIABLES ---
        let scene, camera, renderer, cube, originalCube, gridHelper;
        let controls; 
        
        const sliders = {};
        const sliderOutputs = {};
        const matrixSpans = [];
        const resultSpans = [];
        const originalSpans = [];
        
        let modalOverlay, modalContent, closeModalBtn, viewLogicBtn;
        
        // --- ADDED: Theme color constants ---
        const themeColors = {
            light: {
                sceneBg: 0xF5F5DC,
                wireframe: 0x333333,
                grid1: 0x888888,
                grid2: 0x444444
            },
            dark: {
                sceneBg: 0x222222,
                wireframe: 0xbbbbbb,
                grid1: 0x666666,
                grid2: 0x444444
            }
        };

        // --- 2. INITIALIZATION ---
        function init() {
            const container = document.getElementById('scene-container');
            scene = new THREE.Scene();
            
            // Set initial background color
            scene.background = new THREE.Color(themeColors.light.sceneBg); 
            
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(3, 4, 7);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 0, 0);
            controls.update();

            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            scene.add(new THREE.DirectionalLight(0xffffff, 0.5).position.set(1, 2, 1));
            
            // Create initial grid helper
            gridHelper = new THREE.GridHelper(10, 10, themeColors.light.grid1, themeColors.light.grid2);
            scene.add(gridHelper);
            
            const axisLength = 5;
            const headLength = 0.5;
            const headWidth = 0.2;
            const xAxis = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), new THREE.Vector3(0, 0, 0), axisLength, 0xff0000, headLength, headWidth);
            const yAxis = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(0, 0, 0), axisLength, 0x00ff00, headLength, headWidth);
            const zAxis = new THREE.ArrowHelper(new THREE.Vector3(0, 0, 1), new THREE.Vector3(0, 0, 0), axisLength, 0x0000ff, headLength, headWidth);
            scene.add(xAxis);
            scene.add(yAxis);
            scene.add(zAxis);

            // --- Create Cubes (with Edges) ---
            const geometry = new THREE.BoxGeometry(2, 2, 2); 
            const material = new THREE.MeshStandardMaterial({ color: 0xe74c3c });
            cube = new THREE.Mesh(geometry, material);
            cube.matrixAutoUpdate = false; 
            
            const edgeGeometry = new THREE.EdgesGeometry(geometry);
            const edgeMaterial = new THREE.LineBasicMaterial({ color: 0x000000 }); 
            const cubeEdges = new THREE.LineSegments(edgeGeometry, edgeMaterial);
            cube.add(cubeEdges); 
            scene.add(cube);
            
            // Create initial wireframe cube
            const wireframeMaterial = new THREE.MeshBasicMaterial({ 
                color: themeColors.light.wireframe, // Use theme color
                wireframe: true, 
                transparent: true, 
                opacity: 0.3 
            });
            originalCube = new THREE.Mesh(geometry, wireframeMaterial);
            scene.add(originalCube);

            // --- Link UI Elements ---
            const controlIds = [ 'tx', 'ty', 'tz', 'rx', 'ry', 'rz', 'sx', 'sy', 'sz' ];
            
            controlIds.forEach(id => {
                sliders[id] = document.getElementById(id);
                sliderOutputs[id] = document.querySelector(`label[for="${id}"] span`);
                sliders[id].addEventListener('input', updateSimulation); 
            });
            
            // --- Link Modal UI Elements ---
            modalOverlay = document.getElementById('modal-overlay');
            modalContent = document.getElementById('modal-content');
            closeModalBtn = document.getElementById('modal-close');
            viewLogicBtn = document.getElementById('view-logic-btn');
            
            const finalMatrixContainer = document.getElementById('final-matrix');
            const resultVecContainer = document.getElementById('result-vector');
            const origVecContainer = document.getElementById('original-vector');
            const originalVertexValues = [1, 1, 1, 1]; 

            for (let i = 0; i < 16; i++) {
                const span = document.createElement('span');
                finalMatrixContainer.appendChild(span);
                matrixSpans.push(span);
            }
            
            for (let i = 0; i < 4; i++) {
                const resSpan = document.createElement('span');
                resultVecContainer.appendChild(resSpan);
                resultSpans.push(resSpan);
                
                const origSpan = document.createElement('span');
                origSpan.innerText = originalVertexValues[i].toFixed(1); 
                origVecContainer.appendChild(origSpan);
                originalSpans.push(origSpan);
            }
            
            // --- Modal/Button Event Listeners ---
            viewLogicBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', closeModal); 
            document.getElementById('reset-btn').addEventListener('click', resetValues);
            // --- ADDED: Theme toggle listener ---
            document.getElementById('toggle-theme-btn').addEventListener('click', toggleTheme);
            
            window.addEventListener('resize', onWindowResize);
            
            onWindowResize();
            updateSimulation(); 
        }

        // --- 3. Combined Update Function ---
        function updateSimulation() {
            // 1. Update slider text
            for (const id in sliders) {
                let value = parseFloat(sliders[id].value);
                if (id.startsWith('r')) {
                    sliderOutputs[id].innerText = `${value.toFixed(0)}째`;
                } else {
                    sliderOutputs[id].innerText = `${value.toFixed(1)}`;
                }
            }
            
            // 2. Create all the individual transformation matrices
            const tx = parseFloat(sliders.tx.value);
            const ty = parseFloat(sliders.ty.value);
            const tz = parseFloat(sliders.tz.value);
            const matTranslate = new THREE.Matrix4().makeTranslation(tx, ty, tz);
            
            const rx = THREE.MathUtils.degToRad(parseFloat(sliders.rx.value));
            const ry = THREE.MathUtils.degToRad(parseFloat(sliders.ry.value));
            const rz = THREE.MathUtils.degToRad(parseFloat(sliders.rz.value));
            const euler = new THREE.Euler(rx, ry, rz, 'XYZ');
            const matRotate = new THREE.Matrix4().makeRotationFromEuler(euler);
            
            const sx = parseFloat(sliders.sx.value);
            const sy = parseFloat(sliders.sy.value);
            const sz = parseFloat(sliders.sz.value);
            const matScale = new THREE.Matrix4().makeScale(sx, sy, sz);
            
            // 3. Combine the matrices and apply to the cube
            cube.matrix.identity(); // Reset
            cube.matrix.multiply(matTranslate);
            cube.matrix.multiply(matRotate);
            cube.matrix.multiply(matScale);

            // 4. Update the 4x4 Matrix Display (Column-Major)
            const elements = cube.matrix.elements;
            matrixSpans[0].innerText = elements[0].toFixed(2);
            matrixSpans[1].innerText = elements[4].toFixed(2);
            matrixSpans[2].innerText = elements[8].toFixed(2);
            matrixSpans[3].innerText = elements[12].toFixed(2); 
            matrixSpans[4].innerText = elements[1].toFixed(2);
            matrixSpans[5].innerText = elements[5].toFixed(2);
            matrixSpans[6].innerText = elements[9].toFixed(2);
            matrixSpans[7].innerText = elements[13].toFixed(2);
            matrixSpans[8].innerText = elements[2].toFixed(2);
            matrixSpans[9].innerText = elements[6].toFixed(2);
            matrixSpans[10].innerText = elements[10].toFixed(2);
            matrixSpans[11].innerText = elements[14].toFixed(2);
            matrixSpans[12].innerText = elements[3].toFixed(2);
            matrixSpans[13].innerText = elements[7].toFixed(2);
            matrixSpans[14].innerText = elements[11].toFixed(2);
            matrixSpans[15].innerText = elements[15].toFixed(2);
            
            // 5. Perform the example calculation
            const v_orig = new THREE.Vector4(1, 1, 1, 1);
            const v_result = v_orig.clone().applyMatrix4(cube.matrix);
            
            // 6. Update the result vector display
            resultSpans[0].innerText = v_result.x.toFixed(2);
            resultSpans[1].innerText = v_result.y.toFixed(2);
            resultSpans[2].innerText = v_result.z.toFixed(2);
            resultSpans[3].innerText = v_result.w.toFixed(2);
        }
        
        // --- 4. RESET VALUES FUNCTION ---
        function resetValues() {
            sliders.tx.value = 0; sliders.ty.value = 0; sliders.tz.value = 0;
            sliders.rx.value = 0; sliders.ry.value = 0; sliders.rz.value = 0;
            sliders.sx.value = 1; sliders.sy.value = 1; sliders.sz.value = 1;
            
            updateSimulation();
        }
        
        // --- 5. MODAL FUNCTIONS ---
        function openModal() {
            modalOverlay.style.display = 'block';
            modalContent.style.display = 'block';
        }
        
        function closeModal() {
            modalOverlay.style.display = 'none';
            modalContent.style.display = 'none';
        }
        
        // --- ADDED: 5.5 THEME TOGGLE FUNCTION ---
        function toggleTheme() {
            const currentTheme = document.body.dataset.theme;
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.dataset.theme = newTheme;

            const colors = themeColors[newTheme];
            
            // Update Three.js scene
            scene.background.set(colors.sceneBg);
            originalCube.material.color.set(colors.wireframe);

            // Re-create grid helper
            scene.remove(gridHelper);
            gridHelper = new THREE.GridHelper(10, 10, colors.grid1, colors.grid2);
            scene.add(gridHelper);
            
            // Update button text
            document.getElementById('toggle-theme-btn').innerText = newTheme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
        }

        // --- 6. RENDER LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); 
            renderer.render(scene, camera);
        }

        // --- 7. EVENT HANDLERS ---
        function onWindowResize() {
            const container = document.getElementById('scene-container');
            
            let newWidth, newHeight;
            
            if (window.innerWidth >= 769) {
                newWidth = window.innerWidth - 350; 
                newHeight = window.innerHeight;
            } else {
                newWidth = window.innerWidth;
                newHeight = window.innerHeight * 0.5; 
            }
            
            container.style.width = `${newWidth}px`;
            container.style.height = `${newHeight}px`;

            camera.aspect = newWidth / newHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, newHeight);
        }

        // --- 8. START THE SIMULATION ---
        init();
        animate();

    </script></body>
</html>
